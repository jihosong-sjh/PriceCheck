// prisma/schema.prisma
// 중고 전자제품 가격 가이드 데이터베이스 스키마

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 제품 카테고리 Enum
enum Category {
  SMARTPHONE     // 스마트폰
  LAPTOP         // 노트북
  TABLET         // 태블릿
  SMARTWATCH     // 스마트워치
  EARPHONE       // 이어폰/헤드폰
  SPEAKER        // 블루투스 스피커
  MONITOR        // 모니터
  KEYBOARD_MOUSE // 키보드/마우스
  TV             // TV
}

// 제품 상태 Enum
enum Condition {
  GOOD  // 상 (외관 깨끗, 기능 정상)
  FAIR  // 중 (사용감 있음, 기능 정상)
  POOR  // 하 (외관 손상 있음, 일부 기능 이상)
}

// 중고거래 플랫폼 Enum
enum Platform {
  BUNJANG     // 번개장터
  JOONGONARA  // 중고나라
  HELLOMARKET // 헬로마켓
}

// 알림 타입 Enum
enum NotificationType {
  PRICE_DROP   // 목표가격 도달
  PRICE_CHANGE // 가격 변동
  SYSTEM       // 시스템 알림
}

// 사용자 모델
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  recommendations PriceRecommendation[]
  bookmarks       Bookmark[]
  alerts          PriceAlert[]
  notifications   Notification[]
  refreshTokens   RefreshToken[]

  @@map("users")
}

// 리프레시 토큰 모델 (JWT 토큰 갱신용)
model RefreshToken {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// 토큰 블랙리스트 (로그아웃된 액세스 토큰)
model TokenBlacklist {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([expiresAt])
  @@map("token_blacklist")
}

// 가격 추천 모델
model PriceRecommendation {
  id                 String    @id @default(cuid())
  userId             String?   @map("user_id")
  category           Category
  productName        String    @map("product_name")
  modelName          String?   @map("model_name")
  condition          Condition
  recommendedPrice   Int       @map("recommended_price")
  priceMin           Int       @map("price_min")
  priceMax           Int       @map("price_max")
  marketDataSnapshot Json      @map("market_data_snapshot")
  createdAt          DateTime  @default(now()) @map("created_at")

  user      User?          @relation(fields: [userId], references: [id])
  images    ProductImage[]
  bookmarks Bookmark[]

  @@index([userId, createdAt(sort: Desc)])
  @@index([productName])
  @@index([category])
  @@map("price_recommendations")
}

// 시세 데이터 모델 (크롤링 결과 저장)
model MarketData {
  id          String   @id @default(cuid())
  productName String   @map("product_name")
  modelName   String?  @map("model_name")
  platform    Platform
  price       Int
  condition   String?
  originalUrl String?  @map("original_url")
  scrapedAt   DateTime @map("scraped_at")
  metadata    Json?

  @@index([productName, platform, scrapedAt(sort: Desc)])
  @@index([scrapedAt(sort: Desc)])
  @@map("market_data")
}

// 제품 이미지 모델
model ProductImage {
  id               String   @id @default(cuid())
  recommendationId String   @map("recommendation_id")
  imageUrl         String   @map("image_url")
  uploadedAt       DateTime @default(now()) @map("uploaded_at")

  recommendation PriceRecommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  @@index([recommendationId])
  @@map("product_images")
}

// 북마크(찜하기) 모델
model Bookmark {
  id               String    @id @default(cuid())
  userId           String    @map("user_id")
  recommendationId String?   @map("recommendation_id")

  // 독립 저장용 (히스토리 없이 직접 찜하기)
  category         Category?
  productName      String?   @map("product_name")
  modelName        String?   @map("model_name")

  memo             String?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendation PriceRecommendation? @relation(fields: [recommendationId], references: [id], onDelete: SetNull)

  @@unique([userId, recommendationId])
  @@index([userId, createdAt(sort: Desc)])
  @@map("bookmarks")
}

// 가격 알림 모델
model PriceAlert {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")

  category     Category
  productName  String    @map("product_name")
  modelName    String?   @map("model_name")
  condition    Condition

  targetPrice  Int       @map("target_price")  // 목표 가격 (이 가격 이하면 알림)
  currentPrice Int?      @map("current_price") // 마지막 확인된 가격

  isActive     Boolean   @default(true) @map("is_active")
  lastCheckedAt DateTime? @map("last_checked_at")
  notifiedAt   DateTime? @map("notified_at")   // 마지막 알림 발송 시간

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@index([userId, isActive])
  @@index([isActive, category])
  @@index([isActive, lastCheckedAt])
  @@map("price_alerts")
}

// 알림 메시지 모델
model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  alertId   String?  @map("alert_id")

  type      NotificationType
  title     String
  message   String
  data      Json?

  isRead    Boolean   @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")

  createdAt DateTime  @default(now()) @map("created_at")

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  alert PriceAlert? @relation(fields: [alertId], references: [id], onDelete: SetNull)

  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}
